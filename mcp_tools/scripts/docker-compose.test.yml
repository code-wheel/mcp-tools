version: '3.8'

services:
  drupal:
    image: drupal:10-php8.2-apache
    volumes:
      - ..:/var/www/html/modules/custom/mcp_tools:cached
      - drupal-data:/var/www/html
    environment:
      - SIMPLETEST_DB=sqlite://localhost/sites/default/files/.ht.sqlite
      - SIMPLETEST_BASE_URL=http://localhost
      - BROWSERTEST_OUTPUT_DIRECTORY=/var/www/html/sites/default/files/browser_output
    working_dir: /var/www/html
    command: >
      bash -c "
        set -e

        # Wait for files to be ready
        sleep 2

        # Install composer dependencies if needed
        if [ ! -f vendor/autoload.php ]; then
          composer install --no-interaction --quiet
        fi

        # Install phpunit if needed
        if [ ! -f vendor/bin/phpunit ]; then
          composer require --dev phpunit/phpunit:^10 phpspec/prophecy-phpunit:^2 --quiet
        fi

        # Create test directories
        mkdir -p sites/default/files/browser_output
        chmod -R 777 sites/default/files

        # Run unit tests only (no database needed)
        echo '=== Running Unit Tests ==='
        ./vendor/bin/phpunit \
          --bootstrap vendor/autoload.php \
          modules/custom/mcp_tools/tests/src/Unit/ \
          --colors=always \
          2>&1 || true

        echo ''
        echo '=== Test Run Complete ==='
      "

volumes:
  drupal-data:
